{% extends "base.html" %}
{% load static %}
{% block title %}Simulador - EcoImpact{% endblock %}
{% block head %}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <link rel="stylesheet" href="{% static 'cover.css' %}">
{% endblock %}
{% block content %}
<div class="d-flex w-100 h-100 mx-auto flex-column bg-dark text-white">
        <header class="mb-auto">
             <nav class="navbar navbar-dark bg-dark" aria-label="Dark offcanvas navbar">
                <div class="container-fluid">
                    <div class="d-flex align-items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-leaf me-2" viewBox="0 0 16 16"><path d="M1.4 1.7c.216.289.65.84 1.725 1.274 1.093.44 2.884.774 5.834.528l.37-.023c1.823-.06 3.117.598 3.956 1.579C14.16 6.082 14.5 7.41 14.5 8.5c0 .58-.032 1.285-.229 1.997q.198.248.382.54c.756 1.2 1.19 2.563 1.348 3.966a1 1 0 0 1-1.98.198c-.13-.97-.397-1.913-.868-2.77C12.173 13.386 10.565 14 8 14c-1.854 0-3.32-.544-4.45-1.435-1.125-.887-1.89-2.095-2.391-3.383C.16 6.62.16 3.646.509 1.902L.73.806zm-.05 1.39c-.146 1.609-.008 3.809.74 5.728.457 1.17 1.13 2.213 2.079 2.961.942.744 2.185 1.22 3.83 1.221 2.588 0 3.91-.66 4.609-1.445-1.789-2.46-4.121-1.213-6.342-2.68-.74-.488-1.735-1.323-1.844-2.308-.023-.214.237-.274.38-.112 1.4 1.6 3.573 1.757 5.59 2.045 1.227.215 2.21.526 3 .158.058-.07.11-.14.158-.21z" /></svg>
                        <a href="{% url 'home' %}" class="navbar-brand fs-2 fw-bold">Ecolmpact</a>
                    </div>
                    <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbarDark"><span class="navbar-toggler-icon"></span></button>
                    <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="offcanvasNavbarDark">
                        <div class="offcanvas-header"><h5 class="offcanvas-title">Menu</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button></div>
                        <div class="offcanvas-body">
                            <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
                                <li class="nav-item"><a class="nav-link" href="index.html">Início</a></li>
                                <li class="nav-item"><a class="nav-link active" aria-current="page" href="simulador.html">Simular Resultados</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>
        </header>

        <main role="main">
            <div class="hero-section" style="min-height: 50vh;">
                <div class="text-center">
                    <h2 class="display-4 fw-bold">Simulador de Impacto</h2>
                    <p class="lead">Calcule os impactos ambientais e econômicos da COP-30 em Belém.</p>
                </div>
            </div>
            <div class="container calculator-section">
                <div class="card shadow-sm text-start mb-4 bg-dark text-white">
                    <div class="card-body p-4">
                        <h3 class="card-title h5 mb-4 text-primary">Parâmetros da Simulação</h3>
                                                <div class="row">
                                                                                    <div class="col-12 mb-3">
                                                                                            <label class="form-label">Cidade principal
                                                                                                {% if cidades %}
                                                                                                <select name="cidade_principal" class="form-select" id="cidadePrincipal">
                                                                                                    {% for c in cidades %}
                                                                                                        <option value="{{ c.id }}">{{ c.nome }}</option>
                                                                                                    {% endfor %}
                                                                                                </select>
                                                                                                {% else %}
                                                                                                <input type="text" name="cidade_nome" id="cidadeNomeFallback" class="form-control" placeholder="Nenhuma cidade cadastrada - informe o nome da cidade aqui">
                                                                                                {% endif %}
                                                                                            </label>
                                                                                    </div>
                                                        <!-- Cenário removed -->
                            <div class="col-md-6">
                                <h4 class="h6 text-secondary">Ambiental</h4>
                                <div class="mb-3"><label for="numeroPessoas" class="form-label">Número de Participantes</label><input type="number" class="form-control" id="numeroPessoas" value="50000" oninput="atualizarCalculos()"></div>
                                <div class="mb-3"><label for="diasEvento" class="form-label">Duração do Evento (dias)</label><input type="number" class="form-control" id="diasEvento" value="12" oninput="atualizarCalculos()"></div>
                                <div class="mb-3"><label for="consumoAgua" class="form-label d-flex justify-content-between"><span>Consumo de Água</span><span class="badge text-bg-primary" id="valorAgua">200 L</span></label><input type="range" class="form-range" id="consumoAgua" min="50" max="500" value="200" step="10" oninput="atualizarCalculos()"></div>
                                <div class="mb-3"><label for="taxaReciclagem" class="form-label d-flex justify-content-between"><span>Taxa de Reciclagem</span><span class="badge text-bg-primary" id="valorReciclagem">30 %</span></label><input type="range" class="form-range" id="taxaReciclagem" min="0" max="100" value="30" step="5" oninput="atualizarCalculos()"></div>
                            </div>
                            <div class="col-md-6">
                                <h4 class="h6 text-secondary">Econômico</h4>
                                <div class="mb-3"><label for="gastoTurista" class="form-label">Gasto Diário por Turista (R$)</label><input type="number" class="form-control" id="gastoTurista" value="500" oninput="atualizarCalculos()"></div>
                                <div class="mb-3"><label for="multiplicador" class="form-label d-flex justify-content-between"><span>Multiplicador Econômico</span><span class="badge text-bg-primary" id="valorMultiplicador">1.8</span></label><input type="range" class="form-range" id="multiplicador" min="1.0" max="3.0" value="1.8" step="0.1" oninput="atualizarCalculos()"></div>
                            </div>
                                                </div>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="card h-100 shadow-sm text-start bg-dark text-white">
                            <div class="card-body p-4">
                                <h3 class="card-title h5 mb-3 text-primary">Impacto Econômico</h3>
                                <div class="chart-container">
                                    <canvas id="graficoEconomico"></canvas>
                                </div>
                                <p class="text-center mt-3 small text-white" id="texto-impacto-economico"></p>
                                <p class="text-center mt-1 small text-white" id="texto-pib-cidade"></p>
                                <!-- per-city chart removed as requested -->
                                <div class="text-center mt-3">
                                    <button id="btn-salvar" class="btn btn-sm btn-success">Salvar resultado</button>
                                    <a href="{% url 'simulacao:historico' %}" class="btn btn-sm btn-secondary ms-2">Ver histórico</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card h-100 shadow-sm text-start bg-dark text-white">
                            <div class="card-body p-4">
                                <h3 class="card-title h5 mb-3 text-primary">Impacto Ambiental Agregado</h3>
                                <div class="chart-container">
                                    <canvas id="graficoImpactos"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="mt-auto text-white-50 text-center py-3">
             <p>Projeto Ecolmpact, desenvolvido para a COP-30 em Belém.</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Hidden form to render CSRF token cookie via template tag -->
    <form id="csrf-form" style="display:none;">{% csrf_token %}</form>
    <script>
        // Read CSRF token from cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
        // --- Referências aos Elementos ---
        const ctxImpactos = document.getElementById('graficoImpactos').getContext('2d');
        const ctxEconomico = document.getElementById('graficoEconomico').getContext('2d');
        
    // Inputs
    const inputPessoas = document.getElementById('numeroPessoas');
    const inputDias = document.getElementById('diasEvento');
    const inputAgua = document.getElementById('consumoAgua');
    const inputReciclagem = document.getElementById('taxaReciclagem');
    const valorAguaSpan = document.getElementById('valorAgua');
    const valorReciclagemSpan = document.getElementById('valorReciclagem');
    const inputGastoTurista = document.getElementById('gastoTurista');
    const inputMultiplicador = document.getElementById('multiplicador');
    const valorMultiplicadorSpan = document.getElementById('valorMultiplicador');
    const textoImpactoEconomico = document.getElementById('texto-impacto-economico');
    const cidadePrincipal = document.getElementById('cidadePrincipal');

    const PIB_BELEM_2021_BRL = 33_460_000_000;
    // --- Instâncias dos Gráficos ---
        let graficoImpactos = new Chart(ctxImpactos, { type: 'bar', data: { labels: ['Água (milhões L)', 'Lixo (ton)', 'CO² Total (ton)'], datasets: [{ label: 'Impacto', data: [0, 0, 0], backgroundColor: 'rgba(42, 157, 143, 0.6)', borderColor: '#2a9d8f', borderWidth: 2, borderRadius: 5 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: 'rgba(255, 255, 255, 0.7)' } }, x: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: 'rgba(255, 255, 255, 0.7)' } } }, plugins: { legend: { display: false } } } });
    let graficoEconomico = new Chart(ctxEconomico, { type: 'doughnut', data: { labels: ['Gasto Direto (Turistas)', 'Impacto Indireto (Local)', 'Impacto Total'], datasets: [{ data: [0, 0, 0], backgroundColor: ['rgba(38, 70, 83, 0.7)', 'rgba(42, 157, 143, 0.7)', 'rgba(231, 111, 81, 0.8)'], borderColor: ['#264653', '#2a9d8f', '#e76f51'], borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: 'rgba(255, 255, 255, 0.7)', boxWidth: 12 } } } } });
        
        function formatarDinheiro(valor) {
            if (valor >= 1_000_000_000) return `R$ ${(valor / 1_000_000_000).toFixed(2)} bi`;
            if (valor >= 1_000_000) return `R$ ${(valor / 1_000_000).toFixed(2)} mi`;
            return `R$ ${valor.toFixed(2)}`;
        }

        async function atualizarCalculos() {
            // Leitura dos valores e atualização dos badges
            const numPessoas = parseFloat(inputPessoas.value) || 0;
            const numDias = parseFloat(inputDias.value) || 0;
            const consumoAguaPessoa = parseFloat(inputAgua.value) || 0;
            const taxaReciclagem = parseFloat(inputReciclagem.value) || 0;
            const gastoTurista = parseFloat(inputGastoTurista.value) || 0;
            const multiplicador = parseFloat(inputMultiplicador.value) || 1;
            valorAguaSpan.textContent = `${consumoAguaPessoa} L`;
            valorReciclagemSpan.textContent = `${taxaReciclagem} %`;
            valorMultiplicadorSpan.textContent = multiplicador.toFixed(1);

            const payload = {
                numeroPessoas: numPessoas,
                diasEvento: numDias,
                consumoAgua: consumoAguaPessoa,
                taxaReciclagem: taxaReciclagem,
                gastoTurista: gastoTurista,
                multiplicador: multiplicador
            };

            try {
                // Build query string and use GET to avoid CSRF for read-only calculation
                const params = new URLSearchParams();
                params.set('numeroPessoas', payload.numeroPessoas);
                params.set('diasEvento', payload.diasEvento);
                params.set('consumoAgua', payload.consumoAgua);
                params.set('taxaReciclagem', payload.taxaReciclagem);
                params.set('gastoTurista', payload.gastoTurista);
                params.set('multiplicador', payload.multiplicador);
                // include main city (cenario removed)
                if (cidadePrincipal && cidadePrincipal.value) params.set('cidade_principal', cidadePrincipal.value);

                const url = `{% url 'simulacao:api_calcular' %}` + '?' + params.toString();
                const resp = await fetch(url, { method: 'GET', credentials: 'same-origin' });
                if (!resp.ok) throw new Error('Falha no cálculo');
                const data = await resp.json();

                // Atualiza gráficos com os dados retornados
                const amb = data.ambiental;
                const econ = data.economico;
                if (amb) {
                    graficoImpactos.data.datasets[0].data[0] = (amb.total_agua_l / 1_000_000).toFixed(2);
                    graficoImpactos.data.datasets[0].data[1] = (amb.total_lixo_kg / 1_000).toFixed(2);
                    graficoImpactos.data.datasets[0].data[2] = (amb.co2_total_kg / 1_000).toFixed(2);
                    graficoImpactos.update();
                }
                if (econ) {
                    const gastoDireto = econ.gasto_total;
                    const impactoTotal = econ.impacto_total;
                    const impactoIndireto = (impactoTotal - gastoDireto) || 0;
                    graficoEconomico.data.datasets[0].data[0] = gastoDireto;
                    graficoEconomico.data.datasets[0].data[1] = impactoIndireto;
                    graficoEconomico.data.datasets[0].data[2] = impactoTotal;
                    graficoEconomico.update();
                    // Use returned city PIB if available, otherwise fallback to constant
                    const cidadeInfo = data.cidade;
                    const cidadePib = cidadeInfo && cidadeInfo.pib_total ? cidadeInfo.pib_total : PIB_BELEM_2021_BRL;
                    textoImpactoEconomico.textContent = `Impacto total de R$ ${impactoTotal.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}, equivalente a ${((impactoTotal / cidadePib)*100).toFixed(2)}% do PIB anual da cidade.`;
                    // Show city PIB if provided
                    const pibElem = document.getElementById('texto-pib-cidade');
                    if (pibElem) {
                        if (cidadeInfo && cidadeInfo.pib_total) {
                            const formattedPib = Number(cidadeInfo.pib_total).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
                            pibElem.textContent = `PIB anual da cidade: R$ ${formattedPib}`;
                        } else {
                            pibElem.textContent = '';
                        }
                    }

                    // per-city breakdown removed from UI
                }
            } catch (err) {
                console.error('Erro ao calcular:', err);
            }
        }

        // Debounce helper
        function debounce(fn, wait) {
            let t = null;
            return function(...args) {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(this, args), wait);
            };
        }

        const debouncedAtualizar = debounce(atualizarCalculos, 300);

        // Recalc live when inputs change
    const liveInputs = [inputPessoas, inputDias, inputAgua, inputReciclagem, inputGastoTurista, inputMultiplicador, cidadePrincipal];
        liveInputs.forEach(el => {
            if (!el) return;
            const ev = (el.tagName === 'SELECT' || el.type === 'text' || el.type === 'number') ? 'change' : 'input';
            el.addEventListener(ev, () => {
                valorAguaSpan.textContent = `${inputAgua.value} L`;
                valorReciclagemSpan.textContent = `${inputReciclagem.value} %`;
                valorMultiplicadorSpan.textContent = parseFloat(inputMultiplicador.value).toFixed(1);
                debouncedAtualizar();
            });
            // Save button handler
            const btnSalvar = document.getElementById('btn-salvar');
            if (btnSalvar) {
                let isSaving = false;
                btnSalvar.addEventListener('click', async () => {
                    if (isSaving) return; // prevent double-clicks
                    isSaving = true;
                    btnSalvar.disabled = true;
                    const originalText = btnSalvar.textContent;
                    btnSalvar.textContent = 'Salvando...';
                    // gather current params (same mapping used for calcular)
                    const params = {
                        numero_turistas: parseFloat(inputPessoas.value) || 0,
                        duracao_estadia: parseFloat(inputDias.value) || 0,
                        consumo_agua_por_pessoa: parseFloat(inputAgua.value) || 0,
                        taxa_reciclagem: parseFloat(inputReciclagem.value) || 0,
                        gasto_medio: parseFloat(inputGastoTurista.value) || 0,
                        multiplicador: parseFloat(inputMultiplicador.value) || undefined,
                    };
                    if (cidadePrincipal && cidadePrincipal.value) {
                        params.cidade_id = cidadePrincipal.value;
                        const nome = cidadePrincipal.options[cidadePrincipal.selectedIndex].text;
                        params.cidades_visitadas = [nome];
                    }
                    try {
                        const resp = await fetch(`{% url 'simulacao:salvar_resultado' %}`, {
                            method: 'POST',
                            credentials: 'same-origin',
                            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                            body: JSON.stringify(params)
                        });
                        if (!resp.ok) throw new Error('Falha ao salvar');
                        const j = await resp.json();
                        if (j.simulacao_id) {
                            alert('Simulação salva (id: ' + j.simulacao_id + (j.duplicate ? ' — já existente recente' : '') + ')');
                        } else {
                            alert('Resposta inesperada do servidor.');
                        }
                    } catch (e) {
                        console.error('Erro ao salvar:', e);
                        alert('Erro ao salvar: ' + e.message);
                    }
                    finally {
                        isSaving = false;
                        btnSalvar.disabled = false;
                        btnSalvar.textContent = originalText;
                    }
                });
            }
        });
        console.log(document.getElementById('graficoEconomico'));
console.log(document.getElementById('graficoImpactos'));
    </script>
{% endblock %}